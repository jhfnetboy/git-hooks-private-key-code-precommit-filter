#!/bin/bash

##############################################################################
# Pre-commit hook: Detect private keys in staged files
#
# This hook scans all staged files for actual private key values
# and prevents commits if any are found.
#
# ONLY ACTUAL SECRETS ARE BLOCKED - Keywords and placeholders are allowed:
#
# ‚úÖ Allowed (will NOT block commit):
#    - PRIVATE_KEY=                    (empty value)
#    - TEST_EOA1_PRIVATE_KEY_PLACEHOLDER=paste_your_key_here
#    - private_key: (no value on same line)
#    - Documentation mentioning "private key"
#
# ‚ùå Blocked (will STOP commit):
#    - PRIVATE_KEY=0x1234567890abcdef...  (actual hex value)
#    - -----BEGIN PRIVATE KEY-----        (PEM format)
#    - AWS key patterns (AKIA... or aws_secret_access_key=...)
#
# Patterns checked:
# - Ethereum private keys (0x + 32+ hex chars)
# - PEM format private keys
# - AWS access/secret keys
# - Private key assignments with hex values
##############################################################################

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Files to exclude from scanning
EXCLUDED_DIRS="node_modules|\.git|\.netlify|\.svelte-kit|build|dist|\.next|contracts/broadcast|contracts/cache|contracts/lib|test-results|playwright-report|\.auth"

# File extensions to scan
SCAN_EXTENSIONS="\.(ts|tsx|js|jsx|svelte|sol|md|json|env|example)$"

echo -e "${BLUE}üîí Pre-commit hook: Checking for private keys...${NC}\n"

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo -e "${GREEN}‚úÖ No files to scan for private keys${NC}"
  exit 0
fi

# Filter files to scan
FILES_TO_SCAN=$(echo "$STAGED_FILES" | grep -E "$SCAN_EXTENSIONS" | grep -v -E "$EXCLUDED_DIRS" || true)

if [ -z "$FILES_TO_SCAN" ]; then
  echo -e "${GREEN}‚úÖ No files to scan for private keys${NC}"
  exit 0
fi

FILE_COUNT=$(echo "$FILES_TO_SCAN" | wc -l)
echo -e "${BLUE}üìã Scanning ${FILE_COUNT} file(s) for private keys...${NC}\n"

# Patterns to detect
# 1. Ethereum private key: 0x + 64 hex chars
ETHEREUM_KEY_PATTERN='0x[a-fA-F0-9]\{64\}'

# 2. PEM format private keys (avoid leading dash confusion with grep options)
PEM_PATTERN='BEGIN.*PRIVATE KEY'

# 3. AWS access key
AWS_ACCESS_PATTERN='AKIA[0-9A-Z]\{16\}'

# 4. AWS secret key
AWS_SECRET_PATTERN='aws_secret_access_key[[:space:]]*=[[:space:]]*'

# 5. Private key with actual hex value (0x followed by hex chars, at least 32 chars)
# This catches: PRIVATE_KEY=0x1234... or private_key: 0xabcd...
PRIVATE_KEY_WITH_VALUE_PATTERN='private[_-]key[[:space:]]*[:=][[:space:]]*0x[a-fA-F0-9]{32,}'

# 6. OpenAI API keys (sk-... or sk-proj-...)
OPENAI_KEY_PATTERN='sk-[a-zA-Z0-9]\{48,\}'
OPENAI_PROJ_KEY_PATTERN='sk-proj-[a-zA-Z0-9_-]\{48,\}'

# 7. Google AI (Gemini) API keys (AIza...)
GOOGLE_AI_KEY_PATTERN='AIza[a-zA-Z0-9_-]\{35,\}'

# 8. Anthropic (Claude) API keys (sk-ant-...)
ANTHROPIC_KEY_PATTERN='sk-ant-[a-zA-Z0-9_-]\{95,\}'

# 9. GitHub Personal Access Tokens (ghp_..., gho_..., ghs_...)
GITHUB_PAT_PATTERN='gh[pousr]_[a-zA-Z0-9]\{36,\}'

# 10. Stripe API keys (sk_live_..., sk_test_...)
STRIPE_KEY_PATTERN='sk_\(live\|test\)_[a-zA-Z0-9]\{24,\}'

# 11. Generic API key patterns (api_key=..., apiKey:...)
GENERIC_API_KEY_PATTERN='[aA][pP][iI][_-]\?[kK][eE][yY][[:space:]]*[:=][[:space:]]*["\x27][a-zA-Z0-9_-]\{32,\}["\x27]'

FOUND_SECRETS=0

for FILE in $FILES_TO_SCAN; do
  if [ ! -f "$FILE" ]; then
    continue
  fi

  # Check each pattern
  FINDINGS=""

  if grep -nE "$ETHEREUM_KEY_PATTERN" "$FILE" > /dev/null 2>&1; then
    FINDINGS="${FINDINGS}   [CRITICAL] Ethereum Private Key (256-bit hex)\n"
    FINDINGS="${FINDINGS}$(grep -nE "$ETHEREUM_KEY_PATTERN" "$FILE" | sed 's/^/     /')\n"
    FOUND_SECRETS=1
  fi

  if grep -nE "$PEM_PATTERN" "$FILE" > /dev/null 2>&1; then
    FINDINGS="${FINDINGS}   [CRITICAL] BEGIN PRIVATE KEY\n"
    FINDINGS="${FINDINGS}$(grep -nE "$PEM_PATTERN" "$FILE" | sed 's/^/     /')\n"
    FOUND_SECRETS=1
  fi

  if grep -nE "$AWS_ACCESS_PATTERN" "$FILE" > /dev/null 2>&1; then
    FINDINGS="${FINDINGS}   [CRITICAL] AWS Access Key\n"
    FINDINGS="${FINDINGS}$(grep -nE "$AWS_ACCESS_PATTERN" "$FILE" | sed 's/^/     /')\n"
    FOUND_SECRETS=1
  fi

  if grep -nE "$AWS_SECRET_PATTERN" "$FILE" > /dev/null 2>&1; then
    FINDINGS="${FINDINGS}   [CRITICAL] AWS Secret Key\n"
    FINDINGS="${FINDINGS}$(grep -nE "$AWS_SECRET_PATTERN" "$FILE" | sed 's/^/     /')\n"
    FOUND_SECRETS=1
  fi

  if grep -nEi "$PRIVATE_KEY_WITH_VALUE_PATTERN" "$FILE" > /dev/null 2>&1; then
    # Only flag if there's an actual hex value assigned (not just the keyword/placeholder)
    PRIVATE_KEY_LINES=$(grep -nEi "$PRIVATE_KEY_WITH_VALUE_PATTERN" "$FILE" | grep -v "^[[:space:]]*#" | grep -v "^[[:space:]]*//")
    if [ -n "$PRIVATE_KEY_LINES" ]; then
      FINDINGS="${FINDINGS}   [CRITICAL] Private Key with Hex Value\n"
      FINDINGS="${FINDINGS}$(echo "$PRIVATE_KEY_LINES" | sed 's/^/     /')\n"
      FOUND_SECRETS=1
    fi
  fi

  # Check OpenAI API keys
  if grep -nE "$OPENAI_KEY_PATTERN" "$FILE" > /dev/null 2>&1; then
    OPENAI_LINES=$(grep -nE "$OPENAI_KEY_PATTERN" "$FILE" | grep -v "^[[:space:]]*#" | grep -v "^[[:space:]]*//")
    if [ -n "$OPENAI_LINES" ]; then
      FINDINGS="${FINDINGS}   [CRITICAL] OpenAI API Key\n"
      FINDINGS="${FINDINGS}$(echo "$OPENAI_LINES" | sed 's/^/     /')\n"
      FOUND_SECRETS=1
    fi
  fi

  if grep -nE "$OPENAI_PROJ_KEY_PATTERN" "$FILE" > /dev/null 2>&1; then
    OPENAI_PROJ_LINES=$(grep -nE "$OPENAI_PROJ_KEY_PATTERN" "$FILE" | grep -v "^[[:space:]]*#" | grep -v "^[[:space:]]*//")
    if [ -n "$OPENAI_PROJ_LINES" ]; then
      FINDINGS="${FINDINGS}   [CRITICAL] OpenAI Project API Key\n"
      FINDINGS="${FINDINGS}$(echo "$OPENAI_PROJ_LINES" | sed 's/^/     /')\n"
      FOUND_SECRETS=1
    fi
  fi

  # Check Google AI (Gemini) API keys
  if grep -nE "$GOOGLE_AI_KEY_PATTERN" "$FILE" > /dev/null 2>&1; then
    GOOGLE_LINES=$(grep -nE "$GOOGLE_AI_KEY_PATTERN" "$FILE" | grep -v "^[[:space:]]*#" | grep -v "^[[:space:]]*//")
    if [ -n "$GOOGLE_LINES" ]; then
      FINDINGS="${FINDINGS}   [CRITICAL] Google AI (Gemini) API Key\n"
      FINDINGS="${FINDINGS}$(echo "$GOOGLE_LINES" | sed 's/^/     /')\n"
      FOUND_SECRETS=1
    fi
  fi

  # Check Anthropic (Claude) API keys
  if grep -nE "$ANTHROPIC_KEY_PATTERN" "$FILE" > /dev/null 2>&1; then
    ANTHROPIC_LINES=$(grep -nE "$ANTHROPIC_KEY_PATTERN" "$FILE" | grep -v "^[[:space:]]*#" | grep -v "^[[:space:]]*//")
    if [ -n "$ANTHROPIC_LINES" ]; then
      FINDINGS="${FINDINGS}   [CRITICAL] Anthropic (Claude) API Key\n"
      FINDINGS="${FINDINGS}$(echo "$ANTHROPIC_LINES" | sed 's/^/     /')\n"
      FOUND_SECRETS=1
    fi
  fi

  # Check GitHub tokens
  if grep -nE "$GITHUB_PAT_PATTERN" "$FILE" > /dev/null 2>&1; then
    GITHUB_LINES=$(grep -nE "$GITHUB_PAT_PATTERN" "$FILE" | grep -v "^[[:space:]]*#" | grep -v "^[[:space:]]*//")
    if [ -n "$GITHUB_LINES" ]; then
      FINDINGS="${FINDINGS}   [CRITICAL] GitHub Personal Access Token\n"
      FINDINGS="${FINDINGS}$(echo "$GITHUB_LINES" | sed 's/^/     /')\n"
      FOUND_SECRETS=1
    fi
  fi

  # Check Stripe API keys
  if grep -nE "$STRIPE_KEY_PATTERN" "$FILE" > /dev/null 2>&1; then
    STRIPE_LINES=$(grep -nE "$STRIPE_KEY_PATTERN" "$FILE" | grep -v "^[[:space:]]*#" | grep -v "^[[:space:]]*//")
    if [ -n "$STRIPE_LINES" ]; then
      FINDINGS="${FINDINGS}   [CRITICAL] Stripe API Key\n"
      FINDINGS="${FINDINGS}$(echo "$STRIPE_LINES" | sed 's/^/     /')\n"
      FOUND_SECRETS=1
    fi
  fi

  # Check generic API keys
  if grep -nE "$GENERIC_API_KEY_PATTERN" "$FILE" > /dev/null 2>&1; then
    GENERIC_LINES=$(grep -nE "$GENERIC_API_KEY_PATTERN" "$FILE" | grep -v "^[[:space:]]*#" | grep -v "^[[:space:]]*//")
    if [ -n "$GENERIC_LINES" ]; then
      FINDINGS="${FINDINGS}   [WARNING] Generic API Key Pattern\n"
      FINDINGS="${FINDINGS}$(echo "$GENERIC_LINES" | sed 's/^/     /')\n"
      FOUND_SECRETS=1
    fi
  fi

  if [ -n "$FINDINGS" ]; then
    echo -e "${RED}‚ùå ${FILE}:${NC}"
    echo -e "$FINDINGS"
  fi
done

if [ $FOUND_SECRETS -eq 1 ]; then
  echo -e "${RED}=================================================================================${NC}"
  echo -e "${RED}üö® COMMIT BLOCKED: Private keys detected!${NC}\n"
  echo -e "${YELLOW}‚ö†Ô∏è  Do NOT commit files containing private keys!\n${NC}"
  echo -e "Actions to take:"
  echo -e "  1. ${YELLOW}Remove${NC} the private key(s) from the file(s)"
  echo -e "  2. Ensure sensitive data is ${YELLOW}NOT${NC} in version control"
  echo -e "  3. Use ${BLUE}.env${NC} files for secrets (and add to ${BLUE}.gitignore${NC})"
  echo -e "  4. Stage the corrected files again"
  echo -e "  5. Try committing again\n"
  echo -e "${RED}=================================================================================${NC}\n"
  exit 1
fi

echo -e "${GREEN}‚úÖ No private keys detected in staged files${NC}"
echo -e "${GREEN}‚úÖ Safe to commit!${NC}\n"
exit 0
